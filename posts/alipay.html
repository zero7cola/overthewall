<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <script data-ad-client="ca-pub-3807830837786691" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><title>支付宝支付流程</title><meta name="description" content="My first VuePress Site">
    <link rel="preload" href="/assets/style-CO9XvZyB.css" as="style"><link rel="stylesheet" href="/assets/style-CO9XvZyB.css">
    <link rel="modulepreload" href="/assets/app-CrO7TU3o.js"><link rel="modulepreload" href="/assets/alipay.html-DPItGWY8.js">
    <link rel="prefetch" href="/assets/index.html-CASnJpcW.js" as="script"><link rel="prefetch" href="/assets/get-started.html-CMLD_PdS.js" as="script"><link rel="prefetch" href="/assets/index.html-C3rH5wgk.js" as="script"><link rel="prefetch" href="/assets/index.html-DARhGlPE.js" as="script"><link rel="prefetch" href="/assets/code.html-BOtXcMjN.js" as="script"><link rel="prefetch" href="/assets/api.html-CN-apV60.js" as="script"><link rel="prefetch" href="/assets/applepay.html-GhQGG064.js" as="script"><link rel="prefetch" href="/assets/docker.html-D5PhpJvN.js" as="script"><link rel="prefetch" href="/assets/es.html-Dg9op39k.js" as="script"><link rel="prefetch" href="/assets/haha卡常见问题.html-evk1V1LX.js" as="script"><link rel="prefetch" href="/assets/mock数据的几种方式.html-BsHFM0Cq.js" as="script"><link rel="prefetch" href="/assets/nginx.html-BIhWnO5K.js" as="script"><link rel="prefetch" href="/assets/vm.html-DPnVlwgk.js" as="script"><link rel="prefetch" href="/assets/wechatpay.html-BLJ5uXQ_.js" as="script"><link rel="prefetch" href="/assets/post-demo.html-5Jq44zXZ.js" as="script"><link rel="prefetch" href="/assets/index.html-C5t5YAPL.js" as="script"><link rel="prefetch" href="/assets/404.html-BJx5FuBB.js" as="script"><link rel="prefetch" href="/assets/index.html-CR9UIxUb.js" as="script"><link rel="prefetch" href="/assets/index.html-L9Bi-GmM.js" as="script"><link rel="prefetch" href="/assets/index.html-B1N_x9by.js" as="script"><link rel="prefetch" href="/assets/index.html-NHG1ER3z.js" as="script"><link rel="prefetch" href="/assets/index.html-DvSNTjMT.js" as="script"><link rel="prefetch" href="/assets/index.html-Bj9dMxIc.js" as="script"><link rel="prefetch" href="/assets/index.html-CwUg8A1o.js" as="script"><link rel="prefetch" href="/assets/index.html-Dw3t4Yhf.js" as="script"><link rel="prefetch" href="/assets/index.html-CtCR8FXk.js" as="script"><link rel="prefetch" href="/assets/index.html-CrFJvu2B.js" as="script"><link rel="prefetch" href="/assets/index.html-DlQR34F-.js" as="script"><link rel="prefetch" href="/assets/index.html-DwVjtSCh.js" as="script"><link rel="prefetch" href="/assets/index.html-SEIhQBXp.js" as="script"><link rel="prefetch" href="/assets/index.html-D9-cyd7O.js" as="script"><link rel="prefetch" href="/assets/index.html-2GOlKAvL.js" as="script"><link rel="prefetch" href="/assets/index.html-CcCQvpW_.js" as="script"><link rel="prefetch" href="/assets/index.html-CN3w2G9E.js" as="script"><link rel="prefetch" href="/assets/index.html-DTRITCGG.js" as="script"><link rel="prefetch" href="/assets/index.html-Dis6LkZp.js" as="script"><link rel="prefetch" href="/assets/index.html-B913tdrg.js" as="script"><link rel="prefetch" href="/assets/index.html-_2W8AHlB.js" as="script"><link rel="prefetch" href="/assets/index.html-D93C6C5s.js" as="script"><link rel="prefetch" href="/assets/index.html-C5JISmaJ.js" as="script"><link rel="prefetch" href="/assets/index.html-DyU7J5Mu.js" as="script"><link rel="prefetch" href="/assets/index.html-D_jX5y9X.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="logo" src="/logo-title.jpg" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/card/" aria-label="香港卡"><!--[--><!--[--><!--]--> 香港卡 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/wechat/" aria-label="微信解封"><!--[--><!--[--><!--]--> 微信解封 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索文档" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/card/" aria-label="香港卡"><!--[--><!--[--><!--]--> 香港卡 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/wechat/" aria-label="微信解封"><!--[--><!--[--><!--]--> 微信解封 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">支付宝支付流程 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#总流程" aria-label="总流程"><!--[--><!--[--><!--]--> 总流程 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#代码" aria-label="代码"><!--[--><!--[--><!--]--> 代码 <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#所使用的第三方包" aria-label="所使用的第三方包"><!--[--><!--[--><!--]--> 所使用的第三方包 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#app-h5支付" aria-label="app/H5支付"><!--[--><!--[--><!--]--> app/H5支付 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#扫二维码支付" aria-label="扫二维码支付"><!--[--><!--[--><!--]--> 扫二维码支付 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#支付回调" aria-label="支付回调"><!--[--><!--[--><!--]--> 支付回调 <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="支付宝支付流程" tabindex="-1"><a class="header-anchor" href="#支付宝支付流程"><span>支付宝支付流程</span></a></h1><h2 id="总流程" tabindex="-1"><a class="header-anchor" href="#总流程"><span>总流程</span></a></h2><ul><li>登录 <a href="https://open.alipay.com/" target="_blank" rel="noopener noreferrer">支付宝开放平台 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，进入控制台页面</li><li><a href="https://opendocs.alipay.com/open/200/105310" target="_blank" rel="noopener noreferrer">创建移动应用 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，填写应用信息并提交审核</li><li>在应用详情页面的<code>能力列表</code>中添加<code>APP支付</code>功能，详情参考<a href="https://opendocs.alipay.com/open/200/105310#%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%94%A8%E5%8A%9F%E8%83%BD" target="_blank" rel="noopener noreferrer">添加应用功能 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>进入开发设置完成加密方式、IP白名单等开发信息设置，详情参考<a href="https://opendocs.alipay.com/open/200/105310#%E9%85%8D%E7%BD%AE%E5%BA%94%E7%94%A8%E7%8E%AF%E5%A2%83" target="_blank" rel="noopener noreferrer">配置应用环境 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>添加功能和配置密钥后（获取公钥、私钥，用于服务器生成订单），将应用提交审核，详情参考<a href="https://opendocs.alipay.com/open/200/golive/" target="_blank" rel="noopener noreferrer">上线应用 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>应用上线后，完成签约才能在生产环境使用支付功能，详情参考<a href="https://opendocs.alipay.com/open/200/105314/" target="_blank" rel="noopener noreferrer">签约功能 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><p>更多信息详见支付宝官方文档 <a href="https://opendocs.alipay.com/open/204/105297/" target="_blank" rel="noopener noreferrer">App 支付接入准备 (opens new window)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="代码" tabindex="-1"><a class="header-anchor" href="#代码"><span>代码</span></a></h2><h3 id="所使用的第三方包" tabindex="-1"><a class="header-anchor" href="#所使用的第三方包"><span>所使用的第三方包</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code> &quot;alipaysdk/easysdk&quot;: &quot;2.0&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="app-h5支付" tabindex="-1"><a class="header-anchor" href="#app-h5支付"><span>app/H5支付</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Config</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Factory</span> <span class="token keyword">as</span> AliFactory<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Util<span class="token punctuation">\</span>ResponseChecker</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$options</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">protocol</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;https&#39;</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">gatewayHost</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;openapi.alipay.com&#39;</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">signType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;RSA2&#39;</span><span class="token punctuation">;</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">appId</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;2021003xxxxxxxx&#39;</span><span class="token punctuation">;</span>

		<span class="token comment">// 为避免私钥随源码泄露，推荐从文件中读取私钥字符串而不是写入源码中</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">merchantPrivateKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;xxxx&#39;</span><span class="token punctuation">;</span>
<span class="token comment">//		$options-&gt;alipayCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/alipayCertPublicKey_RSA2.crt&#39;;</span>
<span class="token comment">//		$options-&gt;alipayRootCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/alipayRootCert.crt&#39;;</span>
<span class="token comment">//		$options-&gt;merchantCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/appCertPublicKey_2021003131694042.crt&#39;;</span>

		<span class="token comment">//注：如果采用非证书模式，则无需赋值上面的三个证书路径，改为赋值如下的支付宝公钥字符串即可</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">alipayPublicKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;xxxxx&#39;</span><span class="token punctuation">;</span>

        <span class="token comment">//可设置异步通知接收服务地址（可选）</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">notifyUrl</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;https://tuisong.xxxxxx.com/api/pay/alipay_notify&quot;</span><span class="token punctuation">;</span>

		<span class="token comment">//可设置AES密钥，调用AES加解密相关接口时需要（可选）</span>
		<span class="token comment">//$options-&gt;encryptKey = &quot;&quot;;</span>
		<span class="token comment">//$options-&gt;encryptKey = &quot;&lt;-- 请填写您的AES密钥，例如：aa4BtZ4tspm2wnXLb1ThQA== --&gt;&quot;;</span>


		<span class="token keyword">return</span> <span class="token variable">$options</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token comment">//1. 设置参数（全局只需设置一次）</span>
<span class="token class-name static-context">AliFactory</span><span class="token operator">::</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//$result = AliFactory::payment()-&gt;wap()-&gt;pay($product[&#39;name&#39;], $bill_no, $product[&#39;price&#39;], &#39;https://tuisong.zhanim.com/im/pay&#39;, &#39;https://tuisong.zhanim.com/alipay.html&#39;);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$client_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;app&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token class-name static-context">AliFactory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$bill_no</span><span class="token punctuation">,</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// app支付</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token class-name static-context">AliFactory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">wap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$bill_no</span><span class="token punctuation">,</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;https://wap.xxxx.com/pages/mine/pay_success&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;https://wap.xxxx.com/pages/mine/pay_success&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// H5 支付</span>
    <span class="token punctuation">}</span>


    <span class="token variable">$responseChecker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 处理响应或异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$responseChecker</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        
        <span class="token doc-comment comment">/**
 *  H5支付返回
 * &lt;form id=&#39;alipaysubmit&#39; name=&#39;alipaysubmit&#39; action=&#39;https://openapi.alipay.com/gateway.do?charset=UTF-8&#39; method=&#39;POST&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;method&#39; value=&#39;alipay.trade.wap.pay&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;app_id&#39; value=&#39;2021003132634127&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;timestamp&#39; value=&#39;2022-07-02 20:57:03&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;format&#39; value=&#39;json&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;version&#39; value=&#39;1.0&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;alipay_sdk&#39; value=&#39;alipay-easysdk-php-2.2.2&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;charset&#39; value=&#39;UTF-8&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;sign_type&#39; value=&#39;RSA2&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;biz_content&#39; value=&#39;<span class="token punctuation">{</span>&quot;subject&quot;:&quot;1个月&quot;,&quot;out_trade_no&quot;:&quot;order_2022070220570364783&quot;,&quot;total_amount&quot;:&quot;0.01&quot;,&quot;quit_url&quot;:&quot;https:\/\/im.zhanim.com\/im\/pay&quot;,&quot;product_code&quot;:&quot;QUICK_WAP_WAY&quot;<span class="token punctuation">}</span>&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;return_url&#39; value=&#39;https://im.zhanim.com/alipay.html&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;notify_url&#39; value=&#39;https://im.zhanim.com/api/pay/alipay_notify&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;sign&#39; value=&#39;eQstLbtO15RzOS1xcN8sLkJRCSmX3YtuJJXayua3z7pEDWa3fi94/PXOiTANBujgL1SMIoiW6raEsG9NMKRs15swPcfiMoDl3M7eLreKeQiVPpzK6ZxHXGjHxpP/wP+ft0q++UblTeZNeax4BrZNss29b9jD1x0HPj0a8C+7cXFHlAlCVKsELaYKlXR4sPVpVCqZNk5Noelaug4qFT5z52ZOs6UkyRntwl49gV7RhuUCcCa5y8tM82bS3gn5mzjHPL7Z31ZsNpgKlhGm5zkDtpky9ScttlENbCnZ7FrfQ69m8AZ6+dmrcwzvvFF2yr+YiozdC2Rapx5DLO9gefqLFg==&#39;/&gt;&lt;input type=&#39;submit&#39; value=&#39;ok&#39; style=&#39;display:none;&#39;&#39;&gt;&lt;/form&gt;&lt;script&gt;document.forms[&#39;alipaysubmit&#39;].submit();&lt;/script&gt;
 * 
 * 
 * APP支付返回
 * 
 * app_id=2015052600090779&amp;biz_content=%7B%22timeout_express%22%3A%2230m%22%2C%22seller_id%22%3A%22%22%2C%22product_code%22%3A%22QUICK_MSECURITY_PAY%22%2C%22total_amount%22%3A%220.02%22%2C%22subject%22%3A%221%22%2C%22body%22%3A%22%E6%88%91%E6%98%AF%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%22%2C%22out_trade_no%22%3A%22314VYGIAGG7ZOYY%22%7D&amp;charset=utf-8&amp;method=alipay.trade.app.pay&amp;sign_type=RSA2&amp;timestamp=2016-08-15%2012%3A12%3A15&amp;version=1.0&amp;sign=MsbylYkCzlfYLy9PeRwUUIg9nZPeN9SfXPNavUCroGKR5Kqvx0nEnd3eRmKxJuthNUx4ERCXe552EV9PfwexqW%2B1wbKOdYtDIb4%2B7PL3Pc94RZL0zKaWcaY3tSL89%2FuAVUsQuFqEJdhIukuKygrXucvejOUgTCfoUdwTi7z%2BZzQ%3D

 *  
*/</span>
        <span class="token comment">// 支付成功,处理业务逻辑；h5支付，前端做跳转; app支付 前端拿到数据做支付调用</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">body</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 支付失败</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//echo &quot;调用失败，&quot; . $e-&gt;getMessage() . PHP_EOL;;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="扫二维码支付" tabindex="-1"><a class="header-anchor" href="#扫二维码支付"><span>扫二维码支付</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Config</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Factory</span> <span class="token keyword">as</span> AliFactory<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Alipay<span class="token punctuation">\</span>EasySDK<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Util<span class="token punctuation">\</span>ResponseChecker</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$options</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">protocol</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;https&#39;</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">gatewayHost</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;openapi.alipay.com&#39;</span><span class="token punctuation">;</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">signType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;RSA2&#39;</span><span class="token punctuation">;</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">appId</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;2021003xxxxxxxx&#39;</span><span class="token punctuation">;</span>

		<span class="token comment">// 为避免私钥随源码泄露，推荐从文件中读取私钥字符串而不是写入源码中</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">merchantPrivateKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;xxxx&#39;</span><span class="token punctuation">;</span>
<span class="token comment">//		$options-&gt;alipayCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/alipayCertPublicKey_RSA2.crt&#39;;</span>
<span class="token comment">//		$options-&gt;alipayRootCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/alipayRootCert.crt&#39;;</span>
<span class="token comment">//		$options-&gt;merchantCertPath = &#39;/www/wwwroot/net/popim-web-source/pop-web/ssh/alipay/appCertPublicKey_2021003131694042.crt&#39;;</span>

		<span class="token comment">//注：如果采用非证书模式，则无需赋值上面的三个证书路径，改为赋值如下的支付宝公钥字符串即可</span>

        <span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">alipayPublicKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;xxxxx&#39;</span><span class="token punctuation">;</span>

        <span class="token comment">//可设置异步通知接收服务地址（可选）</span>
		<span class="token variable">$options</span><span class="token operator">-&gt;</span><span class="token property">notifyUrl</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;https://tuisong.xxxxxx.com/api/pay/alipay_notify&quot;</span><span class="token punctuation">;</span>

		<span class="token comment">//可设置AES密钥，调用AES加解密相关接口时需要（可选）</span>
		<span class="token comment">//$options-&gt;encryptKey = &quot;&quot;;</span>
		<span class="token comment">//$options-&gt;encryptKey = &quot;&lt;-- 请填写您的AES密钥，例如：aa4BtZ4tspm2wnXLb1ThQA== --&gt;&quot;;</span>


		<span class="token keyword">return</span> <span class="token variable">$options</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token comment">//1. 设置参数（全局只需设置一次）</span>
<span class="token class-name static-context">AliFactory</span><span class="token operator">::</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">try</span> <span class="token punctuation">{</span>
    
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token class-name static-context">AliFactory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$bill_no</span><span class="token punctuation">,</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;https://tuisong.xxxx.com/im/pay&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token variable">$responseChecker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3. 处理响应或异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$responseChecker</span><span class="token operator">-&gt;</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        
        <span class="token doc-comment comment">/**
 *  支付返回
 * &lt;form id=&#39;alipaysubmit&#39; name=&#39;alipaysubmit&#39; action=&#39;https://openapi.alipay.com/gateway.do?charset=UTF-8&#39; method=&#39;POST&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;method&#39; value=&#39;alipay.trade.page.pay&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;app_id&#39; value=&#39;2021003132634127&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;timestamp&#39; value=&#39;2022-07-02 20:52:34&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;format&#39; value=&#39;json&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;version&#39; value=&#39;1.0&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;alipay_sdk&#39; value=&#39;alipay-easysdk-php-2.2.2&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;charset&#39; value=&#39;UTF-8&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;sign_type&#39; value=&#39;RSA2&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;biz_content&#39; value=&#39;<span class="token punctuation">{</span>&quot;subject&quot;:&quot;1个月&quot;,&quot;out_trade_no&quot;:&quot;order_2022070220523449218&quot;,&quot;total_amount&quot;:&quot;0.01&quot;,&quot;product_code&quot;:&quot;FAST_INSTANT_TRADE_PAY&quot;<span class="token punctuation">}</span>&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;return_url&#39; value=&#39;https://im.zhanim.com/im/pay&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;notify_url&#39; value=&#39;https://im.zhanim.com/api/pay/alipay_notify&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;sign&#39; value=&#39;Iqu50gQ/45rxmdzn5r7tqiAxh3OQKp1NXOVjLPI8+S2LZglfHK8XvIbgZnOoyiqWmiVcN18zezU76Q+cx99poIPVpaIK2ewNiGeIWZAZB/rLPCGRC/1b5PE/+IRzU7asJYXjKHqsBSfXtbIDldlSCSMvgWVc1j9sPuhT7Sv8b7cyzuMQOT3IJ2ETrOwLZ/s8ISo6tN2DvUPYnJCm5xJZTck4rz/QslHQHJPT2JoKhdQwNOVPmOqm6vNhnjeHVYF0+WEZV0khWATpnr70KLfPuHnjDr/RdN1ZywG4oK/NCRqcbI18QpRby1me4JNnLZD5ppaTJOygG56+OmuUmjBM9g==&#39;/&gt;&lt;input type=&#39;submit&#39; value=&#39;ok&#39; style=&#39;display:none;&#39;&#39;&gt;&lt;/form&gt;&lt;script&gt;document.forms[&#39;alipaysubmit&#39;].submit();&lt;/script&gt;
 * 
 * 

 *  
*/</span>
        <span class="token comment">// 支付成功,处理业务逻辑；前端做页面跳转</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">body</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 支付失败</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//echo &quot;调用失败，&quot; . $e-&gt;getMessage() . PHP_EOL;;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="支付回调" tabindex="-1"><a class="header-anchor" href="#支付回调"><span>支付回调</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code>
<span class="token doc-comment comment">/**
 * 支付宝 - 异步回调通知
 *
 * <span class="token punctuation">{</span>
 * &quot;gmt_create&quot;:&quot;2022-07-02 20:24:20&quot;,
 * &quot;charset&quot;:&quot;UTF-8&quot;,
 * &quot;gmt_payment&quot;:&quot;2022-07-02 20:24:25&quot;,
 * &quot;notify_time&quot;:&quot;2022-07-02 20:24:25&quot;,
 * &quot;subject&quot;:&quot;1\u4e2a\u6708&quot;,
 * &quot;sign&quot;:&quot;M1UkkTg35l\/huOZe9apu7IfN3\/\/lby0fK03F4enrkWs+OXu3RNCqBAuEPdoAVEdzH\/hFtk8PqpZrQQcsCGNJlvr0xKbqIJyGQapdH5teMDGLoMZbk0A53Zow3pMFjfSSu0i69+tydhsLGboyrfwY1GNRTC3PkULQvbM197ugS9YMN0pwbE895X+BQVVrab1aLgQEazP0VFP6JCcPg9xtXL84ozKv6kGOClrRQfbx7XpyYHIJiaChnlovnipjgavUsy9OP9sTrxsQNvy3piKHRBtUaft9YGrvsU+7TnJOMpXYUej3MuAIsnuEwH86lUkVqxxK6eZ6TZm4AIuJbp0agg==&quot;,
 * &quot;buyer_id&quot;:&quot;2088202891288381&quot;,
 * &quot;invoice_amount&quot;:&quot;0.01&quot;,
 * &quot;version&quot;:&quot;1.0&quot;,
 * &quot;notify_id&quot;:&quot;2022070200222202425088381419117482&quot;,
 * &quot;fund_bill_list&quot;:&quot;[<span class="token punctuation">{</span>\&quot;amount\&quot;:\&quot;0.01\&quot;,\&quot;fundChannel\&quot;:\&quot;ALIPAYACCOUNT\&quot;<span class="token punctuation">}</span>]&quot;,
 * &quot;notify_type&quot;:&quot;trade_status_sync&quot;,
 * &quot;out_trade_no&quot;:&quot;order_2022070220235324839&quot;,
 * &quot;total_amount&quot;:&quot;0.01&quot;,
 * &quot;trade_status&quot;:&quot;TRADE_SUCCESS&quot;,
 * &quot;trade_no&quot;:&quot;2022070222001488381404118255&quot;,
 * &quot;auth_app_id&quot;:&quot;2021003132634127&quot;,
 * &quot;receipt_amount&quot;:&quot;0.01&quot;,
 * &quot;point_amount&quot;:&quot;0.00&quot;,
 * &quot;buyer_pay_amount&quot;:&quot;0.01&quot;,
 * &quot;app_id&quot;:&quot;2021003132634127&quot;,
 * &quot;sign_type&quot;:&quot;RSA2&quot;,
 * &quot;seller_id&quot;:&quot;2088441134518201&quot;
 * <span class="token punctuation">}</span>
 * <span class="token keyword">@return</span> <span class="token class-name"><span class="token keyword">bool</span><span class="token punctuation">|</span><span class="token keyword">string</span><span class="token punctuation">|</span><span class="token keyword">void</span></span>
 * <span class="token keyword">@throws</span> <span class="token class-name"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>DataNotFoundException</span>
 * <span class="token keyword">@throws</span> <span class="token class-name"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>ModelNotFoundException</span>
 * <span class="token keyword">@throws</span> <span class="token class-name"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>DbException</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">alipay_notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$my_seller_id</span> <span class="token operator">=</span> <span class="token number">2001111111</span><span class="token punctuation">;</span>
    <span class="token variable">$post</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$trade_status</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;trade_status&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token variable">$bill_no</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;out_trade_no&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token variable">$total_amount</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;total_amount&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$pay_bill_no</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;trade_no&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">;</span>
    <span class="token variable">$notify_id</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;notify_id&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$seller_id</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;seller_id&#39;</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">alipay_configs</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$seller_id</span> <span class="token operator">!=</span> <span class="token variable">$my_seller_id</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">&#39;success&#39;</span><span class="token punctuation">;</span>


    <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;orders&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;bill_no&#39;</span><span class="token punctuation">,</span> <span class="token variable">$bill_no</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$order</span> <span class="token operator">||</span> <span class="token variable">$order</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;paid_at&#39;</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果订单不存在 或者 订单已经支付过了</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">&#39;success&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">///////////// &lt;- 建议在这里调用微信的【订单查询】接口查一下该笔订单的情况，确认是已经支付 /////////////</span>
    <span class="token variable">$pay_state</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;fail&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$trade_status</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;TRADE_SUCCESS&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;TRADE_FINISHED&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 支付成功;处理业务逻辑</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment">// 支付失败;处理业务逻辑</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token string single-quoted-string">&#39;success&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CrO7TU3o.js" defer></script>
  </body>
</html>
