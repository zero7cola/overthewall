<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <script data-ad-client="ca-pub-3807830837786691" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><title>微信支付流程</title><meta name="description" content="My first VuePress Site">
    <link rel="preload" href="/assets/style-CO9XvZyB.css" as="style"><link rel="stylesheet" href="/assets/style-CO9XvZyB.css">
    <link rel="modulepreload" href="/assets/app-CrO7TU3o.js"><link rel="modulepreload" href="/assets/wechatpay.html-BLJ5uXQ_.js">
    <link rel="prefetch" href="/assets/index.html-CASnJpcW.js" as="script"><link rel="prefetch" href="/assets/get-started.html-CMLD_PdS.js" as="script"><link rel="prefetch" href="/assets/index.html-C3rH5wgk.js" as="script"><link rel="prefetch" href="/assets/index.html-DARhGlPE.js" as="script"><link rel="prefetch" href="/assets/code.html-BOtXcMjN.js" as="script"><link rel="prefetch" href="/assets/alipay.html-DPItGWY8.js" as="script"><link rel="prefetch" href="/assets/api.html-CN-apV60.js" as="script"><link rel="prefetch" href="/assets/applepay.html-GhQGG064.js" as="script"><link rel="prefetch" href="/assets/docker.html-D5PhpJvN.js" as="script"><link rel="prefetch" href="/assets/es.html-Dg9op39k.js" as="script"><link rel="prefetch" href="/assets/haha卡常见问题.html-evk1V1LX.js" as="script"><link rel="prefetch" href="/assets/mock数据的几种方式.html-BsHFM0Cq.js" as="script"><link rel="prefetch" href="/assets/nginx.html-BIhWnO5K.js" as="script"><link rel="prefetch" href="/assets/vm.html-DPnVlwgk.js" as="script"><link rel="prefetch" href="/assets/post-demo.html-5Jq44zXZ.js" as="script"><link rel="prefetch" href="/assets/index.html-C5t5YAPL.js" as="script"><link rel="prefetch" href="/assets/404.html-BJx5FuBB.js" as="script"><link rel="prefetch" href="/assets/index.html-CR9UIxUb.js" as="script"><link rel="prefetch" href="/assets/index.html-L9Bi-GmM.js" as="script"><link rel="prefetch" href="/assets/index.html-B1N_x9by.js" as="script"><link rel="prefetch" href="/assets/index.html-NHG1ER3z.js" as="script"><link rel="prefetch" href="/assets/index.html-DvSNTjMT.js" as="script"><link rel="prefetch" href="/assets/index.html-Bj9dMxIc.js" as="script"><link rel="prefetch" href="/assets/index.html-CwUg8A1o.js" as="script"><link rel="prefetch" href="/assets/index.html-Dw3t4Yhf.js" as="script"><link rel="prefetch" href="/assets/index.html-CtCR8FXk.js" as="script"><link rel="prefetch" href="/assets/index.html-CrFJvu2B.js" as="script"><link rel="prefetch" href="/assets/index.html-DlQR34F-.js" as="script"><link rel="prefetch" href="/assets/index.html-DwVjtSCh.js" as="script"><link rel="prefetch" href="/assets/index.html-SEIhQBXp.js" as="script"><link rel="prefetch" href="/assets/index.html-D9-cyd7O.js" as="script"><link rel="prefetch" href="/assets/index.html-2GOlKAvL.js" as="script"><link rel="prefetch" href="/assets/index.html-CcCQvpW_.js" as="script"><link rel="prefetch" href="/assets/index.html-CN3w2G9E.js" as="script"><link rel="prefetch" href="/assets/index.html-DTRITCGG.js" as="script"><link rel="prefetch" href="/assets/index.html-Dis6LkZp.js" as="script"><link rel="prefetch" href="/assets/index.html-B913tdrg.js" as="script"><link rel="prefetch" href="/assets/index.html-_2W8AHlB.js" as="script"><link rel="prefetch" href="/assets/index.html-D93C6C5s.js" as="script"><link rel="prefetch" href="/assets/index.html-C5JISmaJ.js" as="script"><link rel="prefetch" href="/assets/index.html-DyU7J5Mu.js" as="script"><link rel="prefetch" href="/assets/index.html-D_jX5y9X.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="logo" src="/logo-title.jpg" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/card/" aria-label="香港卡"><!--[--><!--[--><!--]--> 香港卡 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/wechat/" aria-label="微信解封"><!--[--><!--[--><!--]--> 微信解封 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索文档" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/card/" aria-label="香港卡"><!--[--><!--[--><!--]--> 香港卡 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/wechat/" aria-label="微信解封"><!--[--><!--[--><!--]--> 微信解封 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">微信支付流程 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#总流程" aria-label="总流程"><!--[--><!--[--><!--]--> 总流程 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#代码" aria-label="代码"><!--[--><!--[--><!--]--> 代码 <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#所使用的第三方包" aria-label="所使用的第三方包"><!--[--><!--[--><!--]--> 所使用的第三方包 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#h5支付" aria-label="H5支付"><!--[--><!--[--><!--]--> H5支付 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#扫二维码支付" aria-label="扫二维码支付"><!--[--><!--[--><!--]--> 扫二维码支付 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#支付回调" aria-label="支付回调"><!--[--><!--[--><!--]--> 支付回调 <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="微信支付流程" tabindex="-1"><a class="header-anchor" href="#微信支付流程"><span>微信支付流程</span></a></h1><h2 id="总流程" tabindex="-1"><a class="header-anchor" href="#总流程"><span>总流程</span></a></h2><ul><li>在 <a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F" target="_blank" rel="noopener noreferrer">微信商户平台<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>,注册、登录；</li><li>在 <code>产品中心</code> 申请开通需要的支付</li></ul><blockquote><p><code>native支付</code> 就是扫码支付</p></blockquote><h2 id="代码" tabindex="-1"><a class="header-anchor" href="#代码"><span>代码</span></a></h2><h3 id="所使用的第三方包" tabindex="-1"><a class="header-anchor" href="#所使用的第三方包"><span>所使用的第三方包</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>&quot;overtrue/wechat&quot;: &quot;~4.0&quot;,
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="h5支付" tabindex="-1"><a class="header-anchor" href="#h5支付"><span>H5支付</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat_configs</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// 必要配置</span>
    <span class="token string single-quoted-string">&#39;app_id&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;wx61d01cbcxxxxxxxxx&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;mch_id&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;1626xxxxxxx&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//&#39;key&#39;                =&gt; &#39;812219e4662b9a272f8262b146d6252b&#39;,   // API v2 密钥 (注意: 是v2密钥 是v2密钥 是v2密钥)</span>
    <span class="token string single-quoted-string">&#39;key&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;asdiohsdhiadhad2xxxxxxxxxxx&#39;</span><span class="token punctuation">,</span>

    <span class="token comment">// 如需使用敏感接口（如退款、发送红包等）需要配置 API 证书路径(登录商户平台下载 API 证书)</span>
    <span class="token string single-quoted-string">&#39;cert_path&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;/www/wwwroot/net/xxxxx/ssh/im_apiclient_cert.pem&#39;</span><span class="token punctuation">,</span> <span class="token comment">// XXX: 绝对路径！！！！</span>
    <span class="token string single-quoted-string">&#39;key_path&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;/www/wwwroot/net/xxxxxx/ssh/im_apiclient_key.pem&#39;</span><span class="token punctuation">,</span>      <span class="token comment">// XXX: 绝对路径！！！！</span>

    <span class="token string single-quoted-string">&#39;notify_url&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;https://tuisong.xxxxx.com/api/pay/wechat_notify&#39;</span><span class="token punctuation">,</span>     <span class="token comment">// 你也可以在下单时单独设置来想覆盖它</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token variable">$config</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat_configs</span><span class="token punctuation">;</span>
<span class="token variable">$app</span> <span class="token operator">=</span> <span class="token class-name static-context">Factory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;trade_type&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;MWEB&#39;</span><span class="token punctuation">,</span> <span class="token comment">// h5支付 // JSAPI，NATIVE，APP...</span>
    <span class="token string single-quoted-string">&#39;body&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;detail&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;desc&#39;</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;out_trade_no&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$bill_no</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;total_fee&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 单位：分</span>
    <span class="token string single-quoted-string">&#39;notify_url&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;https://tuisong.zhanim.com/api/pay/wechat_notify&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 支付结果通知网址，如果不设置则会使用配置里的默认地址</span>
    <span class="token comment">//&#39;openid&#39;           =&gt; &#39;当前用户的 openid&#39;, // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// H5支付 下单返回</span>
<span class="token doc-comment comment">/**
 * appid: &quot;wx61d01cbce12ff068&quot;
 * mch_id: &quot;1626800916&quot;
 * mweb_url: &quot;https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=wx300732138415085404c91b85975f2b0000&amp;package=1472621727&quot;
 * nonce_str: &quot;Dw72JY9cHukDPUNT&quot;
 * prepay_id: &quot;wx300732138415085404c91b85975f2b0000&quot;
 * result_code: &quot;SUCCESS&quot;
 * return_code: &quot;SUCCESS&quot;
 * return_msg: &quot;OK&quot;
 * sign: &quot;69C61891D8638240FFD3242BFDB81483&quot;
 * trade_type: &quot;MWEB&quot;
 */</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$app</span><span class="token operator">-&gt;</span><span class="token property">order</span><span class="token operator">-&gt;</span><span class="token function">unify</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;return_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 支付成功，处理业务逻辑；将返回的 `mweb_url` 返回给前端，做跳转,前端可以拼接 成功后需跳转的url  &amp;redirect_url=https://www.xxx.com</span>

   
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 支付失败</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="扫二维码支付" tabindex="-1"><a class="header-anchor" href="#扫二维码支付"><span>扫二维码支付</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat_configs</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// 必要配置</span>
    <span class="token string single-quoted-string">&#39;app_id&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;wx61d01cbcxxxxxxxxx&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;mch_id&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;1626xxxxxxx&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">//&#39;key&#39;                =&gt; &#39;812219e4662b9a272f8262b146d6252b&#39;,   // API v2 密钥 (注意: 是v2密钥 是v2密钥 是v2密钥)</span>
    <span class="token string single-quoted-string">&#39;key&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;asdiohsdhiadhad2xxxxxxxxxxx&#39;</span><span class="token punctuation">,</span>

    <span class="token comment">// 如需使用敏感接口（如退款、发送红包等）需要配置 API 证书路径(登录商户平台下载 API 证书)</span>
    <span class="token string single-quoted-string">&#39;cert_path&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;/www/wwwroot/net/xxxxx/ssh/im_apiclient_cert.pem&#39;</span><span class="token punctuation">,</span> <span class="token comment">// XXX: 绝对路径！！！！</span>
    <span class="token string single-quoted-string">&#39;key_path&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;/www/wwwroot/net/xxxxxx/ssh/im_apiclient_key.pem&#39;</span><span class="token punctuation">,</span>      <span class="token comment">// XXX: 绝对路径！！！！</span>

    <span class="token string single-quoted-string">&#39;notify_url&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;https://tuisong.xxxxx.com/api/pay/wechat_notify&#39;</span><span class="token punctuation">,</span>     <span class="token comment">// 你也可以在下单时单独设置来想覆盖它</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token variable">$config</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat_configs</span><span class="token punctuation">;</span>


<span class="token variable">$app</span> <span class="token operator">=</span> <span class="token class-name static-context">Factory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;trade_type&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;NATIVE&#39;</span><span class="token punctuation">,</span> <span class="token comment">// h5支付 // JSAPI，NATIVE，APP...</span>
    <span class="token string single-quoted-string">&#39;product_id&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;body&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;detail&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;desc&#39;</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;out_trade_no&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$bill_no</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;total_fee&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$product</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 单位：分</span>
    <span class="token string single-quoted-string">&#39;notify_url&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;https://tuisong.xxxx.com/api/pay/wechat_notify&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 支付结果通知网址，如果不设置则会使用配置里的默认地址</span>
    <span class="token comment">//&#39;openid&#39;           =&gt; &#39;当前用户的 openid&#39;, // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token comment">// 扫描二维码支付</span>
<span class="token doc-comment comment">/**
 *appid: &quot;wx61d01cbce12ff068&quot;
    * code_url: &quot;weixin://wxpay/bizpayurl?pr=4Y2AVcXzz&quot;
    * mch_id: &quot;1626800916&quot;
    * nonce_str: &quot;zS4rtk3VD9bo0yez&quot;
    * prepay_id: &quot;wx30084316816247eb354b152ccba7100000&quot;
    * result_code: &quot;SUCCESS&quot;
    * return_code: &quot;SUCCESS&quot;
    * return_msg: &quot;OK&quot;
    * sign: &quot;1F6778EB3824F95D4209E477B66EF409&quot;
    * trade_type: &quot;NATIVE&quot;
    */</span>

<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$app</span><span class="token operator">-&gt;</span><span class="token property">order</span><span class="token operator">-&gt;</span><span class="token function">unify</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;return_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


     <span class="token comment">// 支付成功，处理业务逻辑；将返回的 `code_url` 返回给前端，生成二维码</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 支付失败</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="支付回调" tabindex="-1"><a class="header-anchor" href="#支付回调"><span>支付回调</span></a></h3><div class="language-php line-numbers-mode" data-ext="php" data-title="php"><pre class="language-php"><code><span class="token doc-comment comment">/**
 * 微信支付 - 异步回调通知
 *
 * <span class="token keyword">@throws</span> <span class="token class-name"><span class="token punctuation">\</span>EasyWeChat<span class="token punctuation">\</span>Kernel<span class="token punctuation">\</span>Exceptions<span class="token punctuation">\</span>Exception</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">wechat_notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token class-name static-context">Factory</span><span class="token operator">::</span><span class="token function">payment</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat_configs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 
     * message:
     * <span class="token punctuation">{</span>
     * &quot;appid&quot;:&quot;wx61d01cbce12ff068&quot;,
     * &quot;bank_type&quot;:&quot;OTHERS&quot;,
     * &quot;cash_fee&quot;:&quot;1&quot;,
     * &quot;fee_type&quot;:&quot;CNY&quot;,
     * &quot;is_subscribe&quot;:&quot;Y&quot;,
     * &quot;mch_id&quot;:&quot;1626800916&quot;,
     * &quot;nonce_str&quot;:&quot;62bcf948a3aa3&quot;,
     * &quot;openid&quot;:&quot;o22wx5_3hApYUm2HAKJMH5Cwh4cc&quot;,
     * &quot;out_trade_no&quot;:&quot;pay_2022063009155293490&quot;,
     * &quot;result_code&quot;:&quot;SUCCESS&quot;,
     * &quot;return_code&quot;:&quot;SUCCESS&quot;,
     * &quot;sign&quot;:&quot;1BCE9891A1082B721F3F8DC66A99A1CC&quot;,
     * &quot;time_end&quot;:&quot;20220630091604&quot;,
     * &quot;total_fee&quot;:&quot;1&quot;,
     * &quot;trade_type&quot;:&quot;MWEB&quot;,
     * &quot;transaction_id&quot;:&quot;4200001530202206302614478192&quot;
     * <span class="token punctuation">}</span>
     */</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$app</span><span class="token operator">-&gt;</span><span class="token function">handlePaidNotify</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$fail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用通知里的 &quot;微信支付订单号&quot; 或者 &quot;商户订单号&quot; 去自己的数据库找到订单</span>
        <span class="token variable">$bill_no</span> <span class="token operator">=</span> <span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;out_trade_no&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;orders&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;bill_no&#39;</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;out_trade_no&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$order</span> <span class="token operator">||</span> <span class="token variable">$order</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;paid_at&#39;</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果订单不存在 或者 订单已经支付过了</span>
            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 告诉微信，我已经处理完了，订单没找到，别再通知我了</span>
        <span class="token punctuation">}</span>

        <span class="token comment">///////////// &lt;- 建议在这里调用微信的【订单查询】接口查一下该笔订单的情况，确认是已经支付 /////////////</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;return_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// return_code 表示通信状态，不代表支付状态</span>

            <span class="token variable">$pay_state</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;fail&#39;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;SUCCESS&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 支付成功；处理业务逻辑</span>

            <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$message</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;result_code&#39;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">&#39;FAIL&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 支付失败；处理业务逻辑</span>
            <span class="token punctuation">}</span>


        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$fail</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;通信失败，请稍后再通知我&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回处理完成</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CrO7TU3o.js" defer></script>
  </body>
</html>
